<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexburg Sidewalks During Winter</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body>
    <header>
        <h1>Rexburg Sidewalks During Winter</h1>
        <p>Keeping our community safe, one report at a time.</p>
    </header>

    <main>
        <section class="intro-section">
            <h2>Welcome to Rexburg Sidewalk Reports</h2>
            <p>
                Winter in Rexburg can make sidewalks slippery and dangerous. Use the form below to report icy or poorly maintained sidewalks with a photo and description. Check the map for live updates—red markers show hazards, green markers show resolved issues.
            </p>
        </section>

        <section class="report-section">
            <h2>Report a Sidewalk Issue</h2>
            <p>Help keep Rexburg safe! Follow these steps:</p>
            <ol>
                <li>Describe the issue (e.g., "Icy patch near Main St").</li>
                <li>Upload a photo of the hazard.</li>
                <li>Click "Submit Report" to add it to the map.</li>
            </ol>
            <form id="sidewalk-report">
                <label for="description">Description of Issue:</label>
                <textarea id="description" name="description" rows="4" placeholder="Describe the sidewalk issue here..." required></textarea>

                <label for="image">Upload Hazard Photo:</label>
                <input type="file" id="image" name="image" accept="image/*" required>

                <button type="submit" class="submit-btn">Submit Report</button>
            </form>
            <p id="report-feedback" class="feedback hidden">Report submitted successfully! Check the map.</p>
        </section>

        <section class="map-section">
            <h2>Live Sidewalk Reports</h2>
            <p>Red = Hazardous | Green = Resolved. Click markers for details or to mark resolved.</p>
            <div id="map"></div>
        </section>
    </main>

    <footer>
        <p>© 2025 Rexburg Community. Stay safe this winter!</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        let map;
        let reports = [];
        let markers = [];

        function initMap() {
            map = L.map('map').setView([43.8260, -111.7897], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            reports.forEach(report => addMarker(report));
        }

        document.getElementById("sidewalk-report").addEventListener("submit", function(event) {
            event.preventDefault();

            const description = document.getElementById("description").value;
            const imageFile = document.getElementById("image").files[0];

            const report = {
                id: Date.now(),
                lat: 43.8260 + (Math.random() - 0.5) * 0.01,
                lng: -111.7897 + (Math.random() - 0.5) * 0.01,
                description: description,
                hazardImage: URL.createObjectURL(imageFile),
                status: "hazardous",
                resolvedImage: null,
                resolvedDate: null
            };

            reports.push(report);
            addMarker(report);

            // Show feedback
            const feedback = document.getElementById("report-feedback");
            feedback.classList.remove("hidden");
            setTimeout(() => feedback.classList.add("hidden"), 3000); // Hide after 3 seconds

            this.reset();
        });

        function addMarker(report) {
            const existingMarker = markers.find(m => m.reportId === report.id);
            if (existingMarker) {
                map.removeLayer(existingMarker);
                markers = markers.filter(m => m.reportId !== report.id);
            }

            const markerColor = report.status === "hazardous" ? 'red' : 'green';
            const marker = L.marker([report.lat, report.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<span style="background-color: ${markerColor}; width: 20px; height: 20px; display: block; border-radius: 50%;"></span>`,
                    iconSize: [20, 20]
                })
            }).addTo(map);
            marker.reportId = report.id;
            markers.push(marker);

            const popupContent = createPopupContent(report);
            marker.bindPopup(popupContent);

            marker.on('popupopen', () => attachResolveListener(report));
        }

        function createPopupContent(report) {
            let content = `
                <div class="info-window">
                    <p><strong>${report.description}</strong></p>
                    <p>Status: ${report.status === "hazardous" ? "Hazardous" : "Resolved"}</p>
                    <img src="${report.hazardImage}" alt="Hazard" style="max-width: 200px;">
            `;

            if (report.status === "resolved" && report.resolvedImage) {
                content += `
                    <p>Resolved on: ${report.resolvedDate}</p>
                    <img src="${report.resolvedImage}" alt="Resolved" style="max-width: 200px;">
                `;
            } else {
                content += `
                    <form id="resolve-form-${report.id}" enctype="multipart/form-data">
                        <label for="resolve-image-${report.id}">Upload Resolved Photo:</label>
                        <input type="file" id="resolve-image-${report.id}" accept="image/*" required>
                        <button type="submit" class="resolve-btn">Mark as Resolved</button>
                    </form>
                `;
            }

            content += `</div>`;
            return content;
        }

        function attachResolveListener(report) {
            const form = document.getElementById(`resolve-form-${report.id}`);
            if (form) {
                form.addEventListener("submit", function(event) {
                    event.preventDefault();
                    const resolveImageFile = document.getElementById(`resolve-image-${report.id}`).files[0];
                    
                    report.status = "resolved";
                    report.resolvedImage = URL.createObjectURL(resolveImageFile);
                    report.resolvedDate = new Date().toLocaleDateString();

                    addMarker(report);
                });
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
