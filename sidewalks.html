<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexburg Sidewalks During Winter</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body>
    <header>
        <h1>Rexburg Sidewalks During Winter</h1>
        <p>Keeping our community safe, one report at a time.</p>
    </header>

    <main>
        <section class="intro-section">
            <h2>Welcome to Rexburg Sidewalk Reports</h2>
            <p>
                Winter in Rexburg can make sidewalks slippery and dangerous. Report issues by entering an address or clicking the map, then adding a description and photo. Red markers show hazards, green markers show resolved issues.
            </p>
        </section>

        <section class="report-section">
            <h2>Report a Sidewalk Issue</h2>
            <p>Help keep Rexburg safe! Choose a location by:</p>
            <ol>
                <li>Typing an address below, OR</li>
                <li>Clicking a spot on the map below.</li>
                <li>Then add a description and photo, and submit.</li>
            </ol>
            <form id="sidewalk-report">
                <label for="location">Location (Address):</label>
                <input type="text" id="location" name="location" placeholder="e.g., 123 Main St, Rexburg, ID">

                <label for="description">Description of Issue:</label>
                <textarea id="description" name="description" rows="4" placeholder="Describe the sidewalk issue here..." required></textarea>

                <label for="image">Upload Hazard Photo:</label>
                <input type="file" id="image" name="image" accept="image/*" required>

                <button type="submit" class="submit-btn">Submit Report</button>
            </form>
            <p id="report-feedback" class="feedback hidden">Report submitted successfully! Check the map.</p>
            <p id="location-feedback" class="feedback hidden">Selected location: <span id="lat-lng"></span></p>
        </section>

        <section class="map-section">
            <h2>Live Sidewalk Reports</h2>
            <p>Red = Hazardous | Green = Resolved. Click the map to select a location, or use the form above.</p>
            <div id="map"></div>
        </section>
    </main>

    <footer>
        <p>© 2025 Rexburg Community. Stay safe this winter!</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        let map;
        let reports = [];
        let markers = [];
        let tempMarker = null; // For temporary marker when clicking map
        let selectedLatLng = null; // Store clicked or geocoded location

        function initMap() {
            map = L.map('map').setView([43.8260, -111.7897], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            reports.forEach(report => addMarker(report));

            // Add click event to select location
            map.on('click', function(e) {
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                selectedLatLng = e.latlng;
                tempMarker = L.marker(selectedLatLng, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<span style="background-color: orange; width: 20px; height: 20px; display: block; border-radius: 50%;"></span>',
                        iconSize: [20, 20]
                    })
                }).addTo(map);

                document.getElementById('lat-lng').textContent = `${selectedLatLng.lat.toFixed(5)}, ${selectedLatLng.lng.toFixed(5)}`;
                document.getElementById('location-feedback').classList.remove('hidden');
                document.getElementById('location').value = ''; // Clear address input if map is used
            });
        }

        document.getElementById("sidewalk-report").addEventListener("submit", async function(event) {
            event.preventDefault();

            const location = document.getElementById("location").value.trim();
            const description = document.getElementById("description").value;
            const imageFile = document.getElementById("image").files[0];

            let lat, lng;

            if (location) {
                // Geocode address using Nominatim
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`);
                    const data = await response.json();
                    if (data.length > 0) {
                        lat = parseFloat(data[0].lat);
                        lng = parseFloat(data[0].lon);
                        if (tempMarker) {
                            map.removeLayer(tempMarker);
                            tempMarker = null;
                        }
                    } else {
                        throw new Error("Location not found");
                    }
                } catch (error) {
                    alert("Couldn’t find that address. Please click the map or try a different address.");
                    return;
                }
            } else if (selectedLatLng) {
                // Use map-clicked location
                lat = selectedLatLng.lat;
                lng = selectedLatLng.lng;
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            } else {
                alert("Please enter an address or click the map to select a location.");
                return;
            }

            const report = {
                id: Date.now(),
                lat: lat,
                lng: lng,
                description: description,
                hazardImage: URL.createObjectURL(imageFile),
                status: "hazardous",
                resolvedImage: null,
                resolvedDate: null
            };

            reports.push(report);
            addMarker(report);

            const feedback = document.getElementById("report-feedback");
            feedback.classList.remove("hidden");
            setTimeout(() => feedback.classList.add("hidden"), 3000);

            document.getElementById("location-feedback").classList.add("hidden");
            selectedLatLng = null;
            this.reset();
        });

        function addMarker(report) {
            const existingMarker = markers.find(m => m.reportId === report.id);
            if (existingMarker) {
                map.removeLayer(existingMarker);
                markers = markers.filter(m => m.reportId !== report.id);
            }

            const markerColor = report.status === "hazardous" ? 'red' : 'green';
            const marker = L.marker([report.lat, report.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<span style="background-color: ${markerColor}; width: 20px; height: 20px; display: block; border-radius: 50%;"></span>`,
                    iconSize: [20, 20]
                })
            }).addTo(map);
            marker.reportId = report.id;
            markers.push(marker);

            const popupContent = createPopupContent(report);
            marker.bindPopup(popupContent);

            marker.on('popupopen', () => attachResolveListener(report));
        }

        function createPopupContent(report) {
            let content = `
                <div class="info-window">
                    <p><strong>${report.description}</strong></p>
                    <p>Status: ${report.status === "hazardous" ? "Hazardous" : "Resolved"}</p>
                    <p>Location: ${report.lat.toFixed(5)}, ${report.lng.toFixed(5)}</p>
                    <img src="${report.hazardImage}" alt="Hazard" style="max-width: 200px;">
            `;

            if (report.status === "resolved" && report.resolvedImage) {
                content += `
                    <p>Resolved on: ${report.resolvedDate}</p>
                    <img src="${report.resolvedImage}" alt="Resolved" style="max-width: 200px;">
                `;
            } else {
                content += `
                    <form id="resolve-form-${report.id}" enctype="multipart/form-data">
                        <label for="resolve-image-${report.id}">Upload Resolved Photo:</label>
                        <input type="file" id="resolve-image-${report.id}" accept="image/*" required>
                        <button type="submit" class="resolve-btn">Mark as Resolved</button>
                    </form>
                `;
            }

            content += `</div>`;
            return content;
        }

        function attachResolveListener(report) {
            const form = document.getElementById(`resolve-form-${report.id}`);
            if (form) {
                form.addEventListener("submit", function(event) {
                    event.preventDefault();
                    const resolveImageFile = document.getElementById(`resolve-image-${report.id}`).files[0];
                    
                    report.status = "resolved";
                    report.resolvedImage = URL.createObjectURL(resolveImageFile);
                    report.resolvedDate = new Date().toLocaleDateString();

                    addMarker(report);
                });
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
