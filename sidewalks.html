<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexburg Sidewalks During Winter</title>
    <link rel="stylesheet" href="styles.css" type="text/css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body>
    <section class="intro-section">
        <div class="intro-overlay">
            <h1 class="intro-title">Report an Incident!</h1>
        </div>
    </section>

    <section class="content-section" id="content">
        <div class="report-box">
            <h2>Report a Sidewalk Issue</h2>
            <p>Click the map to mark the issue’s location, then submit below.</p>
            <form id="sidewalk-report">
                <p id="location-feedback" class="feedback hidden">Selected: <span id="lat-lng"></span></p>

                <label for="description">Description:</label>
                <textarea id="description" name="description" rows="3" placeholder="Describe the issue..." required></textarea>

                <label for="image">Upload Photo:</label>
                <input type="file" id="image" name="image" accept="image/*" required>

                <button type="submit" class="submit-btn">Submit Report</button>
            </form>
            <p id="report-feedback" class="feedback hidden">Report submitted!</p>
        </div>
        <div class="map-container">
            <h2>Live Reports</h2>
            <p>Red = Hazardous | Green = Resolved</p>
            <div id="map"></div>
        </div>
    </section>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        let map;
        let reports = JSON.parse(localStorage.getItem('sidewalkReports')) || [];
        let markers = [];
        let tempMarker = null;
        let selectedLatLng = null;

        function initMap() {
            map = L.map('map').setView([43.8260, -111.7897], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            reports.forEach(report => addMarker(report));

            map.on('click', function(e) {
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                selectedLatLng = e.latlng;
                tempMarker = L.marker(selectedLatLng, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<span style="background-color: orange; width: 20px; height: 20px; display: block; border-radius: 50%;"></span>',
                        iconSize: [20, 20]
                    })
                }).addTo(map);

                document.getElementById('lat-lng').textContent = `${selectedLatLng.lat.toFixed(5)}, ${selectedLatLng.lng.toFixed(5)}`;
                document.getElementById('location-feedback').classList.remove('hidden');
            });
        }

        document.getElementById("sidewalk-report").addEventListener("submit", function(event) {
            event.preventDefault();

            const description = document.getElementById("description").value;
            const imageFile = document.getElementById("image").files[0];

            if (!selectedLatLng) {
                alert("Please click the map to select the issue’s location.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const report = {
                    id: Date.now(),
                    lat: selectedLatLng.lat,
                    lng: selectedLatLng.lng,
                    description: description,
                    hazardImage: e.target.result,
                    status: "hazardous",
                    resolvedImage: null,
                    resolvedDate: null
                };

                reports.push(report);
                localStorage.setItem('sidewalkReports', JSON.stringify(reports));
                addMarker(report);

                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                selectedLatLng = null;
                document.getElementById("location-feedback").classList.add("hidden");

                const feedback = document.getElementById("report-feedback");
                feedback.classList.remove("hidden");
                setTimeout(() => feedback.classList.add("hidden"), 3000);

                this.reset();
            };
            reader.readAsDataURL(imageFile);
        });

        function addMarker(report) {
            const existingMarker = markers.find(m => m.reportId === report.id);
            if (existingMarker) {
                map.removeLayer(existingMarker);
                markers = markers.filter(m => m.reportId !== report.id);
            }

            const markerColor = report.status === "hazardous" ? 'red' : 'green';
            const marker = L.marker([report.lat, report.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<span style="background-color: ${markerColor}; width: 20px; height: 20px; display: block; border-radius: 20%;"></span>`,
                    iconSize: [20, 20]
                })
            }).addTo(map);
            marker.reportId = report.id;
            markers.push(marker);

            const popupContent = createPopupContent(report);
            marker.bindPopup(popupContent);

            marker.on('popupopen', () => attachResolveListener(report));
        }

        function createPopupContent(report) {
            let content = `
                <div class="info-window">
                    <p><strong>${report.description}</strong></p>
                    <p>Status: ${report.status === "hazardous" ? "Hazardous" : "Resolved"}</p>
                    <p>Location: ${report.lat.toFixed(5)}, ${report.lng.toFixed(5)}</p>
                    <img src="${report.hazardImage}" alt="Hazard" style="max-width: 200px;">
            `;

            if (report.status === "resolved" && report.resolvedImage) {
                content += `
                    <p>Resolved on: ${report.resolvedDate}</p>
                    <img src="${report.resolvedImage}" alt="Resolved" style="max-width: 200px;">
                `;
            } else {
                content += `
                    <form id="resolve-form-${report.id}" enctype="multipart/form-data">
                        <label for="resolve-image-${report.id}">Upload Resolved Photo:</label>
                        <input type="file" id="resolve-image-${report.id}" accept="image/*" required>
                        <button type="submit" class="resolve-btn">Mark as Resolved</button>
                    </form>
                `;
            }

            content += `</div>`;
            return content;
        }

        function attachResolveListener(report) {
            const form = document.getElementById(`resolve-form-${report.id}`);
            if (form) {
                form.addEventListener("submit", function(event) {
                    event.preventDefault();
                    const resolveImageFile = document.getElementById(`resolve-image-${report.id}`).files[0];
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        report.status = "resolved";
                        report.resolvedImage = e.target.result;
                        report.resolvedDate = new Date().toLocaleDateString();

                        localStorage.setItem('sidewalkReports', JSON.stringify(reports));
                        addMarker(report);
                    };
                    reader.readAsDataURL(resolveImageFile);
                });
            }
        }

        document.querySelector('.intro-title').addEventListener('click', function() {
            document.getElementById('content').scrollIntoView({ behavior: 'smooth' });
        });

        window.onload = initMap;
    </script>
</body>
</html>
